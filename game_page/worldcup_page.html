<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cobubu Worldcup</title>
  <link href="https://fonts.googleapis.com/css2?family=Bitcount+Single:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/worldcup.css">

</head>
<body>

  <div id="genre-popup">
    <h1>Worldcup Genre Choice</h1>

    <!-- button -->
    <div class="popup-buttons">
      <button class="popup-button" id="movieBtn" onclick="loadImages('movie')">
        <img src="/game_asset/worldcup/movie.png" alt="Movie" class="button-bg" />
        <span class="button-label">Movie</span>
      </button>
      <button class="popup-button" id="jjalBtn" onclick="loadImages('jjal')">
        <img src="/game_asset/worldcup/jjal.png" alt="Jjal" class="button-bg" />
        <span class="button-label">Jjal</span>
      </button>
    </div>

    <div class="popup-description">
      <b>Cobubu worldcup</b> ğŸ† is where you choose your favorite <b>cobubu image</b>. ğŸ¨<br>
      From two images displayed on the screen, pick the one you prefer. ğŸ‘‰ğŸ–¼ï¸ğŸ–¼ï¸<br>
      The selected image will advance in a <b>tournament-style bracket</b> until the final match. ğŸ¥Š<br>
      Where youâ€™ll discover the <b>ultimate favorite</b> and see the <b>ranking</b> of cobubu images. ğŸ¥‡ğŸ“Š<br><br><br>
      <b>*ì§¤ (jjal)</b> ğŸ–¼ï¸ is a Korean slang term for a <b>meme</b> or a <b>reaction image</b>,  
      often shared for <b>humor</b> ğŸ˜‚ or <b>emotional expression</b> ğŸ˜­.

    </div>
  </div>

  <h1 id="round-title" style="display: none;">Cobubu Worldcup</h1>

  <div class="image-container" id="image-container" style="display: none;">
    <img id="img1" class="choice-image" src="" alt="choice 1">
    <div class="vs-label">VS</div>
    <img id="img2" class="choice-image" src="" alt="choice 2">
  </div>

  <div id="winner" style="display: none;">
    <div style="display: flex; flex-direction: column; align-items: center;">
      <div>ğŸ† Your Favorite Cobubu Image!</div>
      <img id="winner-img" src="" />
      <div id="winner-desc">
        <h2 id="winner-title"></h2>
        <p id="winner-description"></p>
      </div>
    </div>
  </div>

  <script>
    const img1 = document.getElementById("img1");
  const img2 = document.getElementById("img2");
  const roundTitle = document.getElementById("round-title");

  let fullImageList = [];
  let roundImages = [];
  let nextRound = [];
  let bonusImage = null;
  let descriptionData = {};
  let currentIndex = 0;
  let selectedGenre = "";

  const roundNames = {
    2: "Final",
    4: "Semifinals",
    8: "Quarterfinals",
    16: "Round of 16",
    32: "Round of 32",
    64: "Round of 64"
  };

  function loadImages(type) {
    selectedGenre = type;

    fetch("/json/imageListWorld.json")
      .then(res => res.json())
      .then(data => {
        if (!data[type] || data[type].length < 2) {
          alert("Not enough images to start the Worldcup.");
          return;
        }

        fullImageList = data[type].map(filename =>
          `/game_asset/worldcup/${type}/${encodeURIComponent(filename)}`
        );

        return fetch("/script.txt");
      })
      .then(res => res.text())
      .then(text => {
        const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
        for (let i = 0; i < lines.length; i += 3) {
          const filename = lines[i];
          const title = lines[i + 1] || "";
          const desc = lines[i + 2] || "";
          descriptionData[filename] = { title, desc };
        }

        startWorldcup();
      })
      .catch(err => {
        console.error("âŒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        alert("Failed to load data.");
      });
  }

  window.loadImages = loadImages;

  function startWorldcup() {
    document.getElementById("genre-popup").style.display = "none";
    document.getElementById("round-title").style.display = "block";
    document.getElementById("image-container").style.display = "flex";

    roundImages = [...fullImageList];
    nextRound = [];
    bonusImage = null;
    currentIndex = 0;

    shuffle(roundImages);

    // í™€ìˆ˜ì¼ ê²½ìš° ë§¨ ë§ˆì§€ë§‰ ë¶€ì „ìŠ¹
    if (roundImages.length % 2 === 1) {
      bonusImage = roundImages.pop();
    }

    updateTitle();
    showImages();
  }

  function updateTitle() {
    const remaining = roundImages.length + (bonusImage ? 1 : 0);
    roundTitle.innerText = `Cobubu Worldcup - ${roundNames[remaining] || `Top ${remaining}`}`;
  }

  function showImages() {
    if (currentIndex >= roundImages.length) {
      if (bonusImage) {
        nextRound.push(bonusImage);
        bonusImage = null;
      }

      if (nextRound.length === 1) {
        displayWinner(nextRound[0]);
        return;
      }

      roundImages = [...nextRound];
      shuffle(roundImages);
      if (roundImages.length % 2 === 1) {
        bonusImage = roundImages.pop();
      }
      nextRound = [];
      currentIndex = 0;
      updateTitle();
    }

    const imgA = roundImages[currentIndex];
    const imgB = roundImages[currentIndex + 1];
    img1.src = imgA;
    img2.src = imgB;

    img1.onclick = () => {
      nextRound.push(imgA);
      currentIndex += 2;
      showImages();
    };

    img2.onclick = () => {
      nextRound.push(imgB);
      currentIndex += 2;
      showImages();
    };
  }

  function displayWinner(winnerImg) {
    document.getElementById("image-container").style.display = "none";
    document.getElementById("winner").style.display = "block";

    const winnerImage = document.getElementById("winner-img");
    winnerImage.src = winnerImg;
    winnerImage.style.display = "block";
    roundTitle.innerText = "ğŸ† Final Winner!";

    const filename = decodeURIComponent(winnerImg.split("/").pop());
    const info = descriptionData[filename];
    if (info) {
      const infoDiv = document.createElement("div");
      infoDiv.innerHTML = `
        <div style="margin-top: 2vw; font-size: 1.5vw;">
          Your Favorite Cobubu <b>${selectedGenre}</b> image is <br>
          <b>${info.title}</b><br>
          <i>${info.desc}</i>
        </div>
      `;
      document.body.appendChild(infoDiv);
    } else {
      console.warn("ğŸ›‘ ì„¤ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:", filename);
    }
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }


  function startRandomColorAnimation(element) {
    element._colorInterval = setInterval(() => {
      const r = Math.floor(Math.random() * 256);
      const g = Math.floor(Math.random() * 256);
      const b = Math.floor(Math.random() * 256);
      element.style.color = `rgb(${r},${g},${b})`;
    }, 50);
  }

  function stopRandomColorAnimation(element) {
    clearInterval(element._colorInterval);
    element.style.color = 'white';
  }

  // ëŒ€ìƒ span ìš”ì†Œ ì°¾ê¸°
  const movieLabel = document.querySelector('#movieBtn .button-label');
  const jjalLabel = document.querySelector('#jjalBtn .button-label');

  // ë§ˆìš°ìŠ¤ ë°˜ì§ì„ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.getElementById('movieBtn').addEventListener('mouseenter', () => startRandomColorAnimation(movieLabel));
  document.getElementById('movieBtn').addEventListener('mouseleave', () => stopRandomColorAnimation(movieLabel));
  document.getElementById('jjalBtn').addEventListener('mouseenter', () => startRandomColorAnimation(jjalLabel));
  document.getElementById('jjalBtn').addEventListener('mouseleave', () => stopRandomColorAnimation(jjalLabel));
</script>
</script>

</body>
</html>
